<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cashflow Loan Applications Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/assets/js/gsap.min.js"></script>
    <script src="/static/assets/js/framer-motion.umd.js"></script>
</head>
<body class="bg-green-50 min-h-screen">
<!-- Login Modal -->
<div id="login-modal" class="fixed inset-0 flex items-center justify-center bg-gradient-to-br from-green-100 via-white to-green-50 z-50">
    <div id="login-modal-inner" class="bg-white rounded-3xl shadow-2xl px-8 py-10 max-w-sm w-full border border-gray-200 flex flex-col items-center relative">
    <img src="/static/assets/images/logo.jpeg" alt="Cashflow Logo" class="w-16 h-16 rounded-full mb-4 shadow border border-gray-200">
        <h2 class="text-2xl font-semibold text-gray-800 mb-2 tracking-tight font-sans">Sign in to Admin</h2>
        <p class="text-gray-500 mb-6 text-base font-sans">to manage loan applications</p>
        <form id="login-form" class="w-full flex flex-col gap-4">
            <input type="text" id="admin-username" class="px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 text-base font-sans bg-gray-50 placeholder-gray-400" placeholder="Username" required autocomplete="username">
            <input type="password" id="admin-password" class="px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 text-base font-sans bg-gray-50 placeholder-gray-400" placeholder="Password" required autocomplete="current-password">
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg text-base font-sans transition-all duration-200 shadow-sm mt-2">Sign in</button>
            <div id="login-error" class="text-red-600 text-center text-sm font-semibold hidden"></div>
        </form>
        <button id="show-register-btn" class="mt-4 text-green-700 underline text-sm">Register as Admin</button>
        <div class="mt-6 text-xs text-gray-400 font-sans">&copy; 2025 Cashflow Loans</div>
    </div>
</div>

<!-- Register Modal -->
<div id="register-modal" class="fixed inset-0 flex items-center justify-center bg-gradient-to-br from-green-100 via-white to-green-50 z-50 hidden">
    <div id="register-modal-inner" class="bg-white rounded-3xl shadow-2xl px-8 py-10 max-w-sm w-full border border-gray-200 flex flex-col items-center relative">
    <img src="/static/assets/images/logo.jpeg" alt="Cashflow Logo" class="w-16 h-16 rounded-full mb-4 shadow border border-gray-200">
        <h2 class="text-2xl font-semibold text-gray-800 mb-2 tracking-tight font-sans">Register Admin</h2>
        <form id="register-form" class="w-full flex flex-col gap-4">
            <input type="text" id="register-username" class="px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 text-base font-sans bg-gray-50 placeholder-gray-400" placeholder="Username" required autocomplete="username">
            <input type="password" id="register-password" class="px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 text-base font-sans bg-gray-50 placeholder-gray-400" placeholder="Password" required autocomplete="new-password">
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg text-base font-sans transition-all duration-200 shadow-sm mt-2">Register</button>
            <div id="register-error" class="text-red-600 text-center text-sm font-semibold hidden"></div>
            <div id="register-success" class="text-green-600 text-center text-sm font-semibold hidden"></div>
        </form>
        <button id="show-login-btn" class="mt-4 text-green-700 underline text-sm">Back to Login</button>
        <div class="mt-6 text-xs text-gray-400 font-sans">&copy; 2025 Cashflow Loans</div>
    </div>
</div>
<div id="admin-dashboard" class="max-w-5xl mx-auto my-12 bg-white rounded-3xl shadow-2xl p-10 border border-green-100 hidden">
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-3xl font-bold text-green-900">Admin Dashboard</h1>
      <button id="logout-btn" class="bg-green-100 hover:bg-green-200 text-green-900 font-semibold px-5 py-2 rounded-lg shadow transition-all duration-200">Logout</button>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-10">
      <div class="bg-green-100 rounded-xl p-6 flex flex-col items-center">
        <div class="text-4xl font-bold text-green-900" id="stat-unsecured">0</div>
        <div class="text-green-800 mt-2 font-semibold">Unsecured Applications</div>
      </div>
      <div class="bg-green-100 rounded-xl p-6 flex flex-col items-center">
        <div class="text-4xl font-bold text-green-900" id="stat-secured">0</div>
        <div class="text-green-800 mt-2 font-semibold">Secured Applications</div>
      </div>
      <div class="bg-green-100 rounded-xl p-6 flex flex-col items-center">
        <div class="text-4xl font-bold text-green-900" id="stat-admins">0</div>
        <div class="text-green-800 mt-2 font-semibold">Admins</div>
      </div>
    </div>
    <div class="flex gap-4">
      <button id="view-submissions-btn" class="bg-green-700 hover:bg-green-900 text-white font-semibold px-6 py-3 rounded-lg shadow transition-all duration-200">View Submitted Forms</button>
    </div>
</div>

<div id="admin-content" class="max-w-6xl mx-auto my-10 bg-white p-8 rounded-xl shadow-lg hidden">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-green-900">Cashflow Loan Applications Admin</h1>
        <button id="back-to-dashboard-btn" class="bg-green-100 hover:bg-green-200 text-green-900 font-semibold px-5 py-2 rounded-lg shadow transition-all duration-200">Back to Dashboard</button>
    </div>
    <div class="flex gap-2 mb-8 border-b">
        <button class="tab-btn px-6 py-2 rounded-t-lg font-semibold text-lg bg-green-50 text-green-900 border-none transition-colors active" data-tab="unsecured">Unsecured Loans</button>
        <button class="tab-btn px-6 py-2 rounded-t-lg font-semibold text-lg bg-green-50 text-green-900 border-none transition-colors" data-tab="secured">Secured Loans</button>
    </div>
    <div class="tab-content active" id="tab-unsecured">
        <div class="mb-4">
            <input class="search-input px-3 py-2 border border-gray-300 rounded w-64 text-base" id="search-unsecured" type="text" placeholder="Search by name, surname, email, ID...">
        </div>
        <div class="overflow-x-auto">
        <table id="unsecured-table" class="min-w-full bg-white border border-green-200 rounded-xl shadow-sm overflow-hidden">
            <thead>
            <tr class="bg-gradient-to-r from-green-100 to-green-50 text-green-900">
                <th class="py-3 px-4 font-semibold text-left">ID</th>
                <th class="py-3 px-4 font-semibold text-left">Name</th>
                <th class="py-3 px-4 font-semibold text-left">Surname</th>
                <th class="py-3 px-4 font-semibold text-left">Amount</th>
                <th class="py-3 px-4 font-semibold text-left">Email</th>
                <th class="py-3 px-4 font-semibold text-left">Details</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
        </div>
    </div>
    <div class="tab-content" id="tab-secured">
        <div class="mb-4">
            <input class="search-input px-3 py-2 border border-gray-300 rounded w-64 text-base" id="search-secured" type="text" placeholder="Search by name, email, ID...">
        </div>
        <div class="overflow-x-auto">
        <table id="secured-table" class="min-w-full bg-white border border-green-200 rounded-xl shadow-sm overflow-hidden">
            <thead>
            <tr class="bg-gradient-to-r from-green-100 to-green-50 text-green-900">
                <th class="py-3 px-4 font-semibold text-left">ID</th>
                <th class="py-3 px-4 font-semibold text-left">Name</th>
                <th class="py-3 px-4 font-semibold text-left">Amount</th>
                <th class="py-3 px-4 font-semibold text-left">Email</th>
                <th class="py-3 px-4 font-semibold text-left">Details</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
        </div>
    </div>
    <div id="modal-bg" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 z-50 hidden flex items-center justify-center transition-all duration-300">
        <div id="modal-content" class="bg-white rounded-2xl max-w-2xl w-[95vw] p-10 shadow-2xl border-2 border-green-200 relative scale-90 opacity-0">
            <button class="absolute top-4 right-6 text-3xl text-gray-400 hover:text-green-900 transition-colors duration-200" onclick="closeModal()">&times;</button>
            <div id="modal-body" class="text-gray-800"></div>
        </div>
    </div>
</div>
<script>


// --- Auth logic using backend endpoints ---
let loginModal, loginModalInner, loginForm, loginError, adminContent, logoutBtn, showRegisterBtn, registerModal, registerModalInner, registerForm, registerError, registerSuccess, showLoginBtn;

// --- Dashboard and navigation logic ---
let adminDashboard, backToDashboardBtn, viewSubmissionsBtn;

function showLogin() {
    loginModal.classList.remove('hidden');
    registerModal.classList.add('hidden');
        adminContent.classList.add('hidden');
        adminDashboard.classList.add('hidden');
    gsap.set(loginModalInner, {scale:0.92, opacity:0});
    gsap.to(loginModalInner, {scale:1, opacity:1, duration:0.4, ease:'power3.out'});
}
function showRegister() {
    loginModal.classList.add('hidden');
    registerModal.classList.remove('hidden');
        adminContent.classList.add('hidden');
        adminDashboard.classList.add('hidden');
    gsap.set(registerModalInner, {scale:0.92, opacity:0});
    gsap.to(registerModalInner, {scale:1, opacity:1, duration:0.4, ease:'power3.out'});
}
function showDashboard() {
        loginModal.classList.add('hidden');
        registerModal.classList.add('hidden');
        adminDashboard.classList.remove('hidden');
        adminContent.classList.add('hidden');
        gsap.fromTo(adminDashboard, {opacity:0, y:40}, {opacity:1, y:0, duration:0.4, ease:'power3.out'});
        // Fetch stats
        fetch('https://cashflow-bybn.onrender.com/admin/stats').then(r=>r.json()).then(stats => {
            document.getElementById('stat-unsecured').textContent = stats.unsecured_loans;
            document.getElementById('stat-secured').textContent = stats.secured_loans;
            document.getElementById('stat-admins').textContent = stats.admins;
        });
}
function showSubmissions() {
        adminDashboard.classList.add('hidden');
        adminContent.classList.remove('hidden');
        gsap.fromTo(adminContent, {opacity:0, y:40}, {opacity:1, y:0, duration:0.4, ease:'power3.out'});
}
function showAdmin() {
        showDashboard();
}
function doLogout() {
    localStorage.removeItem('admin-auth');
    showLogin();
}
function checkAuth() {
    if(localStorage.getItem('admin-auth')==='1') {
                showDashboard();
    } else {
        showLogin();
    }
}

window.addEventListener('DOMContentLoaded', function() {
    // Get elements after DOM is loaded
    loginModal = document.getElementById('login-modal');
    loginModalInner = document.getElementById('login-modal-inner');
    loginForm = document.getElementById('login-form');
    loginError = document.getElementById('login-error');
        adminContent = document.getElementById('admin-content');
        adminDashboard = document.getElementById('admin-dashboard');
        backToDashboardBtn = document.getElementById('back-to-dashboard-btn');
        viewSubmissionsBtn = document.getElementById('view-submissions-btn');
    logoutBtn = document.getElementById('logout-btn');
    showRegisterBtn = document.getElementById('show-register-btn');
    registerModal = document.getElementById('register-modal');
    registerModalInner = document.getElementById('register-modal-inner');
    registerForm = document.getElementById('register-form');
    registerError = document.getElementById('register-error');
    registerSuccess = document.getElementById('register-success');
    showLoginBtn = document.getElementById('show-login-btn');

        if (viewSubmissionsBtn) {
            viewSubmissionsBtn.addEventListener('click', showSubmissions);
        }
        if (backToDashboardBtn) {
            backToDashboardBtn.addEventListener('click', showDashboard);
        }

    // Show register modal
    showRegisterBtn.addEventListener('click', showRegister);
    showLoginBtn.addEventListener('click', showLogin);

    // Login form submit
    loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const user = document.getElementById('admin-username').value.trim();
        const pass = document.getElementById('admin-password').value;
        loginError.classList.add('hidden');
        fetch('/admin/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username: user, password: pass})
        })
        .then(r => r.json())
        .then(data => {
            if(data.success) {
                localStorage.setItem('admin-auth','1');
                localStorage.setItem('admin-username', user); // Store username for dashboard
                window.location.href = '/dashboard.html'; // Redirect to dashboard after login
                loginForm.reset();
            } else {
                loginError.textContent = data.message || 'Invalid username or password.';
                loginError.classList.remove('hidden');
                gsap.fromTo(loginError, {x:-10, opacity:0.5}, {x:0, opacity:1, duration:0.3, ease:'power2.out'});
            }
        })
        .catch(() => {
            loginError.textContent = 'Server error. Please try again.';
            loginError.classList.remove('hidden');
        });
    });

    // Register form submit
    registerForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const user = document.getElementById('register-username').value.trim();
        const pass = document.getElementById('register-password').value;
        registerError.classList.add('hidden');
        registerSuccess.classList.add('hidden');
        fetch('/admin/register', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username: user, password: pass})
        })
        .then(r => r.json())
        .then(data => {
            if(data.success) {
                registerSuccess.textContent = 'Registration successful! You can now log in.';
                registerSuccess.classList.remove('hidden');
                registerError.classList.add('hidden');
                registerForm.reset();
                // Refresh stats after successful registration
                showDashboard();
            } else {
                registerError.textContent = data.message || 'Registration failed.';
                registerError.classList.remove('hidden');
            }
        })
        .catch(() => {
            registerError.textContent = 'Server error. Please try again.';
            registerError.classList.remove('hidden');
        });
    });

    logoutBtn.addEventListener('click', doLogout);
    checkAuth();
});

// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.tab-btn').forEach(b => {
            b.classList.remove('active', 'bg-green-900', 'text-white');
            b.classList.add('bg-green-50', 'text-green-900');
        });
        document.querySelectorAll('.tab-content').forEach(tc => {
            tc.classList.remove('active');
            tc.style.display = 'none';
        });
        btn.classList.add('active', 'bg-green-900', 'text-white');
        btn.classList.remove('bg-green-50', 'text-green-900');
        const tab = document.getElementById('tab-' + btn.dataset.tab);
        tab.classList.add('active');
        tab.style.display = 'block';
    });
});
// On load, ensure only the first tab is visible
document.querySelectorAll('.tab-content').forEach((tc, i) => {
    if (i === 0) {
        tc.classList.add('active');
        tc.style.display = 'block';
    } else {
        tc.classList.remove('active');
        tc.style.display = 'none';
    }
});

function createFileLink(filename) {
    if (!filename) return '';
    const ext = filename.split('.').pop().toLowerCase();
    const isImage = ['jpg','jpeg','png'].includes(ext);
    let html = '';
    if (isImage) {
        html += `<a href="/uploads/${encodeURIComponent(filename)}" target="_blank"><img src="/uploads/${encodeURIComponent(filename)}" alt="image" class="inline-block max-w-[80px] max-h-[80px] align-middle mr-2 rounded border border-gray-300"></a>`;
    }
    html += `<a class='file-link text-green-700 underline mr-2' href="/uploads/${encodeURIComponent(filename)}" target="_blank" download>Download</a>`;
    return html;
}
function unsecuredDetails(row) {
    return `<h3 class='text-xl font-bold text-green-900 mb-2'>Unsecured Loan Details</h3>
        <div class='bg-gray-50 rounded p-4 mb-2'>
        <span class='font-semibold'>ID:</span> ${row.id}<br>
        <span class='font-semibold'>Name:</span> ${row.name} ${row.surname}<br>
        <span class='font-semibold'>ID Number:</span> ${row.id_number}<br>
        <span class='font-semibold'>Phone:</span> ${row.phone}<br>
        <span class='font-semibold'>Email:</span> ${row.email}<br>
        <span class='font-semibold'>Amount:</span> R${row.amount}<br>
        <span class='font-semibold'>Payslip:</span> ${createFileLink(row.payslip_filename)}<br>
        <span class='font-semibold'>ID Document:</span> ${createFileLink(row.id_document_filename)}<br>
        <span class='font-semibold'>Bank Statement:</span> ${createFileLink(row.bank_statement_filename)}<br>
        <span class='font-semibold'>Terms Accepted:</span> ${row.terms_accepted ? 'Yes' : 'No'}
    </div>`;
}
function securedDetails(row) {
    let images = (row.collateral_images_filenames || []).map(f => createFileLink(f)).join(' ');
    return `<h3 class='text-xl font-bold text-green-900 mb-2'>Secured Loan Details</h3>
        <div class='bg-gray-50 rounded p-4 mb-2'>
        <span class='font-semibold'>ID:</span> ${row.id}<br>
        <span class='font-semibold'>Name:</span> ${row.name}<br>
        <span class='font-semibold'>ID Number:</span> ${row.id_number}<br>
        <span class='font-semibold'>Phone:</span> ${row.phone}<br>
        <span class='font-semibold'>Email:</span> ${row.email}<br>
        <span class='font-semibold'>Amount:</span> R${row.amount}<br>
        <span class='font-semibold'>Collateral Images:</span><br>${images ? images : 'None'}<br>
        <span class='font-semibold'>Terms Accepted:</span> ${row.terms_accepted ? 'Yes' : 'No'}
    </div>`;
}
function showModal(html) {
    // Show modal and animate in
    const modalBg = document.getElementById('modal-bg');
    const modalContent = document.getElementById('modal-content');
    document.getElementById('modal-body').innerHTML = html;
    modalBg.classList.remove('hidden');
    // Animate modal in (Tailwind + GSAP fallback)
    modalContent.style.opacity = 0;
    modalContent.style.transform = 'scale(0.92)';
    setTimeout(() => {
        modalContent.style.transition = 'all 0.3s cubic-bezier(.4,2,.6,1)';
        modalContent.style.opacity = 1;
        modalContent.style.transform = 'scale(1)';
    }, 10);
}
function closeModal() {
    // Animate modal out, then hide
    const modalBg = document.getElementById('modal-bg');
    const modalContent = document.getElementById('modal-content');
    modalContent.style.transition = 'all 0.2s cubic-bezier(.4,2,.6,1)';
    modalContent.style.opacity = 0;
    modalContent.style.transform = 'scale(0.92)';
    setTimeout(() => {
        modalBg.classList.add('hidden');
    }, 200);
}

// Fetch and render unsecured loans
let unsecuredData = [];
fetch('https://cashflow-bybn.onrender.com/submissions/unsecured').then(r=>r.json()).then(data=>{
    unsecuredData = data;
    renderUnsecuredTable();
});

// Fetch and render secured loans
let securedData = [];
fetch('https://cashflow-bybn.onrender.com/submissions/secured').then(r=>r.json()).then(data=>{
    securedData = data;
    renderSecuredTable();
});

function renderSecuredTable() {
    const tbody = document.querySelector('#secured-table tbody');
    tbody.innerHTML = '';
    let search = document.getElementById('search-secured').value.toLowerCase();
    securedData.filter(row =>
        row.name.toLowerCase().includes(search) ||
        row.email.toLowerCase().includes(search) ||
        row.id_number.toLowerCase().includes(search)
    ).forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.id}</td><td>${row.name}</td><td>R${row.amount}</td><td>${row.email}</td><td><button class='btn' onclick='showModal(securedDetails(${JSON.stringify(row)}))'>View</button></td>`;
        tbody.appendChild(tr);
    });
}
document.getElementById('search-secured').addEventListener('input', renderSecuredTable);
function renderUnsecuredTable() {
    const tbody = document.querySelector('#unsecured-table tbody');
    tbody.innerHTML = '';
    let search = document.getElementById('search-unsecured').value.toLowerCase();
    unsecuredData.filter(row =>
        row.name.toLowerCase().includes(search) ||
        row.surname.toLowerCase().includes(search) ||
        row.email.toLowerCase().includes(search) ||
        row.id_number.toLowerCase().includes(search)
    ).forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.id}</td><td>${row.name}</td><td>${row.surname}</td><td>R${row.amount}</td><td>${row.email}</td><td><button class='btn' onclick='showModal(unsecuredDetails(${JSON.stringify(row)}))'>View</button></td>`;
        tbody.appendChild(tr);
    });
}
document.getElementById('search-unsecured').addEventListener('input', renderUnsecuredTable);
function unsecuredDetails(row) {
        return `
        <div class="space-y-2">
            <h3 class='text-2xl font-bold text-green-900 mb-4 tracking-tight'>Unsecured Loan Details</h3>
            <div class='grid grid-cols-1 sm:grid-cols-2 gap-4 bg-green-50 rounded-xl p-6 mb-2 border border-green-100'>
                <div><span class='font-semibold'>ID:</span> <span class='text-gray-700'>${row.id}</span></div>
                <div><span class='font-semibold'>Name:</span> <span class='text-gray-700'>${row.name} ${row.surname}</span></div>
                <div><span class='font-semibold'>ID Number:</span> <span class='text-gray-700'>${row.id_number}</span></div>
                <div><span class='font-semibold'>Phone:</span> <span class='text-gray-700'>${row.phone}</span></div>
                <div><span class='font-semibold'>Email:</span> <span class='text-gray-700'>${row.email}</span></div>
                <div><span class='font-semibold'>Amount:</span> <span class='text-gray-700'>R${row.amount}</span></div>
                <div><span class='font-semibold'>Payslip:</span> ${createFileLink(row.payslip_filename)}</div>
                <div><span class='font-semibold'>ID Document:</span> ${createFileLink(row.id_document_filename)}</div>
                <div><span class='font-semibold'>Bank Statement:</span> ${createFileLink(row.bank_statement_filename)}</div>
                <div><span class='font-semibold'>Terms Accepted:</span> <span class='text-gray-700'>${row.terms_accepted ? 'Yes' : 'No'}</span></div>
            </div>
        </div>
        `;
}

function securedDetails(row) {
        let images = (row.collateral_images_filenames || []).map(f => createFileLink(f)).join(' ');
        return `
        <div class="space-y-2">
            <h3 class='text-2xl font-bold text-green-900 mb-4 tracking-tight'>Secured Loan Details</h3>
            <div class='grid grid-cols-1 sm:grid-cols-2 gap-4 bg-green-50 rounded-xl p-6 mb-2 border border-green-100'>
                <div><span class='font-semibold'>ID:</span> <span class='text-gray-700'>${row.id}</span></div>
                <div><span class='font-semibold'>Name:</span> <span class='text-gray-700'>${row.name}</span></div>
                <div><span class='font-semibold'>ID Number:</span> <span class='text-gray-700'>${row.id_number}</span></div>
                <div><span class='font-semibold'>Phone:</span> <span class='text-gray-700'>${row.phone}</span></div>
                <div><span class='font-semibold'>Email:</span> <span class='text-gray-700'>${row.email}</span></div>
                <div><span class='font-semibold'>Amount:</span> <span class='text-gray-700'>R${row.amount}</span></div>
                <div class='col-span-2'><span class='font-semibold'>Collateral Images:</span><br>${images ? images : 'None'}</div>
                <div><span class='font-semibold'>Terms Accepted:</span> <span class='text-gray-700'>${row.terms_accepted ? 'Yes' : 'No'}</span></div>
            </div>
        </div>
        `;
}

</script>
</body>
</html>
