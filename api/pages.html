<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Submitted Forms - Cashflow Loans</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-green-50 via-white to-green-100 min-h-screen">
  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-green-100 flex flex-col py-8 px-6 shadow-xl">
      <div class="flex items-center gap-3 mb-10">
        <img src="/static/assets/images/logo.jpeg" alt="Logo" class="w-12 h-12 rounded-full shadow border border-green-200">
        <span class="text-2xl font-bold text-green-800 tracking-tight">Cashflow Admin</span>
      </div>
      <nav class="flex flex-col gap-2 mt-4">
        <a href="/dashboard.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-green-700 hover:bg-green-50 transition">
          <svg class="w-6 h-6 text-green-700" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M13 5v6h6"/></svg>
          Dashboard
        </a>
        <a href="/pages.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-green-900 font-semibold bg-green-100">
          <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-6a2 2 0 012-2h2a2 2 0 012 2v6m-6 0h6"/></svg>
          Applications
        </a>
      </nav>
    </aside>
    <!-- Main Content -->
    <main class="flex-1 p-12 bg-gradient-to-br from-white via-green-50 to-green-100">
      <div class="flex justify-between items-center mb-10">
        <h1 class="text-4xl font-extrabold text-green-900 tracking-tight">Submitted Loan Applications</h1>
        <a href="/dashboard.html" class="bg-green-700 hover:bg-green-900 text-white font-semibold px-6 py-3 rounded-lg shadow transition-all duration-200 flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
          Back to Dashboard
        </a>
      </div>
      <div class="mb-8 flex gap-4">
        <button class="tab-btn px-8 py-3 rounded-t-xl font-semibold text-lg bg-green-50 text-green-900 border-none transition-colors active flex items-center gap-2" data-tab="unsecured">
          <svg class="w-5 h-5 text-green-700" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 0V4m0 16v-4"/></svg>
          Unsecured Loans
        </button>
        <button class="tab-btn px-8 py-3 rounded-t-xl font-semibold text-lg bg-green-50 text-green-900 border-none transition-colors flex items-center gap-2" data-tab="secured">
          <svg class="w-5 h-5 text-blue-700" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a5 5 0 00-10 0v2a5 5 0 00-1 9.9V21a1 1 0 001 1h10a1 1 0 001-1v-2.1A5 5 0 0017 9z"/></svg>
          Secured Loans
        </button>
      </div>
      <div class="tab-content active" id="tab-unsecured">
        <div class="overflow-x-auto rounded-2xl shadow-lg border border-green-200">
          <table id="unsecured-table" class="min-w-full bg-white rounded-2xl overflow-hidden">
            <thead>
              <tr class="bg-gradient-to-r from-green-100 to-green-50 text-green-900 text-lg">
                <th class="py-4 px-6 font-bold text-left">ID</th>
                <th class="py-4 px-6 font-bold text-left">Name</th>
                <th class="py-4 px-6 font-bold text-left">Surname</th>
                <th class="py-4 px-6 font-bold text-left">Amount</th>
                <th class="py-4 px-6 font-bold text-left">Email</th>
                <th class="py-4 px-6 font-bold text-left">Details</th>
                 <th class="py-4 px-6 font-bold text-left">Delete</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="tab-content" id="tab-secured">
        <div class="overflow-x-auto rounded-2xl shadow-lg border border-blue-200">
          <table id="secured-table" class="min-w-full bg-white rounded-2xl overflow-hidden">
            <thead>
              <tr class="bg-gradient-to-r from-blue-100 to-blue-50 text-blue-900 text-lg">
                <th class="py-4 px-6 font-bold text-left">ID</th>
                <th class="py-4 px-6 font-bold text-left">Name</th>
                <th class="py-4 px-6 font-bold text-left">Amount</th>
                <th class="py-4 px-6 font-bold text-left">Email</th>
                <th class="py-4 px-6 font-bold text-left">Details</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div id="modal-bg" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-70 backdrop-blur-sm z-50 hidden flex items-center justify-center transition-all duration-300">
        <div id="modal-content" class="relative max-w-2xl w-[95vw] p-0 transform scale-90 opacity-0 transition-all duration-300">
          <div class="bg-white/70 backdrop-blur-lg rounded-3xl shadow-2xl border border-green-200 ring-1 ring-green-100 p-10 flex flex-col items-center relative overflow-hidden">
            <button id="modal-close-btn" class="absolute top-4 right-6 text-3xl text-gray-400 hover:text-green-700 transition-all duration-300 focus:outline-none transform hover:scale-125 active:scale-95">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-8 h-8">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
            <div id="modal-body" class="text-gray-900 w-full"></div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <script>
    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.tab-btn').forEach(b => {
          b.classList.remove('active', 'bg-green-900', 'text-white');
          b.classList.add('bg-green-50', 'text-green-900');
        });
        document.querySelectorAll('.tab-content').forEach(tc => {
          tc.classList.remove('active');
          tc.style.display = 'none';
        });
        btn.classList.add('active', 'bg-green-900', 'text-white');
        btn.classList.remove('bg-green-50', 'text-green-900');
        const tab = document.getElementById('tab-' + btn.dataset.tab);
        tab.classList.add('active');
        tab.style.display = 'block';
      });
    });
    document.querySelectorAll('.tab-content').forEach((tc, i) => {
      if (i === 0) {
        tc.classList.add('active');
        tc.style.display = 'block';
      } else {
        tc.classList.remove('active');
        tc.style.display = 'none';
      }
    });
    // Fetch and render unsecured loans
    let unsecuredData = [];
    fetch('/submissions/unsecured').then(r=>r.json()).then(data=>{
      unsecuredData = data;
      renderUnsecuredTable();
    });
    function renderUnsecuredTable() {
      const tbody = document.querySelector('#unsecured-table tbody');
      tbody.innerHTML = '';
      unsecuredData.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.id}</td><td>${row.name}</td><td>${row.surname}</td><td>R${row.amount}</td><td>${row.email}</td><td><button class='btn' onclick='showModal(unsecuredDetails(${JSON.stringify(row)}))'>View</button></td>`;
  tr.innerHTML = `<td>${row.id}</td><td>${row.name}</td><td>${row.surname}</td><td>R${row.amount}</td><td>${row.email}</td><td><button class='btn' onclick='showModal(unsecuredDetails(${JSON.stringify(row)}))'>View</button></td><td><button class='delete-btn bg-red-100 hover:bg-red-200 text-red-700 rounded-full p-2 transition' title='Delete' onclick='deleteUnsecured(${row.id}, this)'><svg xmlns='http://www.w3.org/2000/svg' class='w-5 h-5' fill='none' viewBox='0 0 24 24' stroke='currentColor' stroke-width='2'><path stroke-linecap='round' stroke-linejoin='round' d='M6 18L18 6M6 6l12 12'/></svg></button></td>`;
        tbody.appendChild(tr);
      });
    }
    // Fetch and render secured loans
    let securedData = [];
    fetch('/submissions/secured').then(r=>r.json()).then(data=>{
      securedData = data;
      renderSecuredTable();
    });
    function renderSecuredTable() {
      const tbody = document.querySelector('#secured-table tbody');
      tbody.innerHTML = '';
      securedData.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.id}</td><td>${row.name}</td><td>R${row.amount}</td><td>${row.email}</td><td><button class='btn' onclick='showModal(securedDetails(${JSON.stringify(row)}))'>View</button></td>`;
        tr.innerHTML = `<td>${row.id}</td><td>${row.name}</td><td>R${row.amount}</td><td>${row.email}</td><td><button class='btn' onclick='showModal(securedDetails(${JSON.stringify(row)}))'>View</button></td><td><button class='delete-btn bg-red-100 hover:bg-red-200 text-red-700 rounded-full p-2 transition' title='Delete' onclick='deleteSecured(${row.id}, this)'><svg xmlns='http://www.w3.org/2000/svg' class='w-5 h-5' fill='none' viewBox='0 0 24 24' stroke='currentColor' stroke-width='2'><path stroke-linecap='round' stroke-linejoin='round' d='M6 18L18 6M6 6l12 12'/></svg></button></td>`;
        tbody.appendChild(tr);
      });
    }
    // Delete unsecured loan
    function deleteUnsecured(id, btn) {
      if (!confirm('Are you sure you want to delete this unsecured application?')) return;
      btn.disabled = true;
      fetch(`/submissions/unsecured/${id}`, { method: 'DELETE' })
        .then(r => {
          if (r.ok) {
            btn.closest('tr').remove();
          } else {
            btn.disabled = false;
            alert('Failed to delete.');
          }
        })
        .catch(() => {
          btn.disabled = false;
          alert('Failed to delete.');
        });
    }
    // Delete secured loan
    function deleteSecured(id, btn) {
      if (!confirm('Are you sure you want to delete this secured application?')) return;
      btn.disabled = true;
      fetch(`/submissions/secured/${id}`, { method: 'DELETE' })
        .then(r => {
          if (r.ok) {
            btn.closest('tr').remove();
          } else {
            btn.disabled = false;
            alert('Failed to delete.');
          }
        })
        .catch(() => {
          btn.disabled = false;
          alert('Failed to delete.');
        });
    }
    function createFileLink(filename) {
      if (!filename) return '';
      const ext = filename.split('.').pop().toLowerCase();
      const isImage = ['jpg','jpeg','png'].includes(ext);
      let html = '';
      if (isImage) {
        html += `<a href="/uploads/${encodeURIComponent(filename)}" target="_blank"><img src="/uploads/${encodeURIComponent(filename)}" alt="image" class="inline-block max-w-[80px] max-h-[80px] align-middle mr-2 rounded border border-gray-300"></a>`;
      }
      html += `<a class='file-link text-green-700 underline mr-2' href="/uploads/${encodeURIComponent(filename)}" target="_blank" download>Download</a>`;
      return html;
    }
    function unsecuredDetails(row) {
      return `<h3 class='text-xl font-bold text-green-900 mb-2'>Unsecured Loan Details</h3>
        <div class='bg-gray-50 rounded p-4 mb-2'>
        <span class='font-semibold'>ID:</span> ${row.id}<br>
        <span class='font-semibold'>Name:</span> ${row.name} ${row.surname}<br>
        <span class='font-semibold'>ID Number:</span> ${row.id_number}<br>
        <span class='font-semibold'>Phone:</span> ${row.phone}<br>
        <span class='font-semibold'>Email:</span> ${row.email}<br>
        <span class='font-semibold'>Amount:</span> R${row.amount}<br>
        <span class='font-semibold'>Payslip:</span> ${createFileLink(row.payslip_filename)}<br>
        <span class='font-semibold'>ID Document:</span> ${createFileLink(row.id_document_filename)}<br>
        <span class='font-semibold'>Bank Statement:</span> ${createFileLink(row.bank_statement_filename)}<br>
        <span class='font-semibold'>Terms Accepted:</span> ${row.terms_accepted ? 'Yes' : 'No'}
    </div>`;
    }
    function securedDetails(row) {
      let images = (row.collateral_images_filenames || []).map(f => createFileLink(f)).join(' ');
      return `<h3 class='text-xl font-bold text-green-900 mb-2'>Secured Loan Details</h3>
        <div class='bg-gray-50 rounded p-4 mb-2'>
        <span class='font-semibold'>ID:</span> ${row.id}<br>
        <span class='font-semibold'>Name:</span> ${row.name}<br>
        <span class='font-semibold'>ID Number:</span> ${row.id_number}<br>
        <span class='font-semibold'>Phone:</span> ${row.phone}<br>
        <span class='font-semibold'>Email:</span> ${row.email}<br>
        <span class='font-semibold'>Amount:</span> R${row.amount}<br>
        <span class='font-semibold'>Collateral Images:</span><br>${images ? images : 'None'}<br>
        <span class='font-semibold'>Terms Accepted:</span> ${row.terms_accepted ? 'Yes' : 'No'}
    </div>`;
    }
    function showModal(html) {
      document.getElementById('modal-body').innerHTML = html;
      const bg = document.getElementById('modal-bg');
      const modal = document.getElementById('modal-content');
      bg.classList.remove('hidden');
      setTimeout(() => {
        modal.classList.remove('scale-90', 'opacity-0');
        modal.classList.add('scale-100', 'opacity-100');
      }, 10);
    }
    function closeModal() {
      const bg = document.getElementById('modal-bg');
      const modal = document.getElementById('modal-content');
      modal.classList.remove('scale-100', 'opacity-100');
      modal.classList.add('scale-90', 'opacity-0');
      setTimeout(() => {
        bg.classList.add('hidden');
      }, 250);
    }
    // Modal close button event
    document.addEventListener('DOMContentLoaded', function() {
      const closeBtn = document.getElementById('modal-close-btn');
      if (closeBtn) closeBtn.onclick = closeModal;
      // Also close modal on background click
      document.getElementById('modal-bg').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
      });
    });
  </script>
</body>
</html>
